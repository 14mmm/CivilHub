{% extends 'locations/index.html' %}
{% load staticfiles %}
{% load bookmarks_tags %}
{% load i18n %}

{% block content %}
<div class="col-sm-9">
    <h3>
        <a href="{{ idea.get_absolute_url }}">{{ idea.name }}</a> 
        <small>
            {% trans "Created by" %} <a href="{% url 'user:profile' idea.creator %}">{{ idea.creator.get_full_name }}</a> {{ idea.date_created }}
        </small>
    </h3>
    {% if idea.creator == user %}
        <p><a href="{% url 'ideas:update' idea.slug %}">{% trans "Edit" %}</a></p>
        <p><a href="#" class="map-marker-toggle">{% trans "Add map marker" %}</a></p>
    {% endif %}
    {% bookmark_form for idea %}
    <div class="idea-votes">
        <div class="votes">{{ idea.get_votes }}</div>
        {% if user.is_authenticated %}
            <button data-target-id="{{ idea.pk }}" data-vote="up" class="vote-btn btn btn-default">+</button>
            <button data-target-id="{{ idea.pk }}" data-vote="down" class="vote-btn btn btn-default">-</button>
        {% endif %}
    </div>
    <div>
        <a class="report-abuse-link" href="{% url 'reports:report' app_label='ideas' model_label='idea' object_pk=idea.pk %}">{% trans "Report abuse" %}</a>
    </div>
    <div>{{ idea.description | safe }}</div>
    <div class="post-meta">
        <p>{% trans "Created by" %} {{ idea.creator }} | {{ idea.date_created }}</p>
        {% if idea.edited %}<p>{% trans "Last time edited" %}: {{ idea.date_edited }}</p>{% endif %}
        <p>{% trans "Status" %}: {{ idea.status }}</p>
    </div>
    <p>{% trans "Tags" %}:</p>
    <ul>
        {% for tag in idea.tags.all %}
        <li>{{ tag }}</li>
        {% endfor %}
    </ul>
    <div>
        <p>
            {% trans "Comments" %}: <span class="badge comment-count">{{ idea.comments }}</span>
            <a class="comment-toggle" data-target="{{ idea.pk }}" href="#">{% trans "Hide comments" %}</a>
        </p>
    </div>
    <input type="hidden" id="target-id" value="{{ idea.pk }}" />
    <input type="hidden" id="target-label" value="ideas" />
    <input type="hidden" id="target-type" value="{{ idea.content_type }}" />
    <input type="hidden" id="target-user" value="{{ user.username }}" />
    <input type="hidden" id="target-avatar" value="{{ user.profile.avatar.url }}" />
    <input type="hidden" id="target-user-fullname" value="{{ user.get_full_name }}" />
    {% include 'comments/commentlist.html' %}
</div>
{% endblock %}

{% block footer_scripts %}

{% comment %}
    Templatka dla formularza dodawania punktów na mapie. Formularz wypełniany
    jest automatycznie na podstawie wybranej treści.
{% endcomment %}
{% if marker_form %}{% comment %}
<script type="text/template" id="map-marker-form-template">
<div id="map-marker-form" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">{% trans "Create map marker" %}</h4>
            </div>
            <div class="modal-body">
                <form role="form" method="post" action="{% url 'maps:save' %}">
                    {{ marker_form }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Close" %}</button>
                <button type="button" class="btn btn-primary submit-btn">{% trans "Save" %}</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</script>
<script src="{% static 'maps/js/jquery.mapinput.js' %}"></script>
<script>
(function ($) {
    "use strict";
    $('.map-marker-toggle').bind('click', function (evt) {
        evt.preventDefault();
        var $modal   = $(_.template($('#map-marker-form-template').html(), {})),
            $form    = $modal.find('form:first'),
            $submit  = $modal.find('.submit-btn:first'),
            formData = {};
            
        $modal.modal('show');
        
        $modal.on('shown.bs.modal', function () {
            
            $('#id_latitude').before('<div id="map"></div>');
            $('#map').mapinput({
                latField: '#id_latitude',
                lngField: '#id_longitude',
                width: 550,
                height: 300
            });
            
            $form.on('submit', function (evt) {
                evt.preventDefault();
            });
            
            $submit.on('click', function () {
                formData = {
                    content_type: $('#id_content_type').val(),
                    object_pk   : $('#id_object_pk').val(),
                    latitude    : $('#id_latitude').val(),
                    longitude   : $('#id_longitude').val()
                }
                console.log(formData);
                
                sendAjaxRequest('POST', $form.attr('action'), {
                    data: formData,
                    success: function (resp) {
                        display_alert(resp.message, resp.level);
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
                
                $modal.modal('hide');
            });
        });
        
        $modal.on('hidden.bs.modal', function () {
            $modal.empty().remove();
            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();
        });
    });
})(jQuery);
</script>
{% endcomment %}{% endif %}
<script src="{% static 'ideas/js/votes.js' %}"></script>
{% endblock %}