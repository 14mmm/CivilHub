{% extends 'places_core/base.html' %}
{% load staticfiles %}{% load i18n %}

{% block require_scripts %}

    <script>
    require.config({
        baseUrl: "{% static 'places_core' %}",
        
        urlArgs: "bust=" + (new Date()).getTime(),
        
        waitSeconds: 300,
        
        paths: {
            jquery: 'includes/jquery/jquery',
            bootstrap: 'includes/bootstrap/bootstrap',
            underscore: 'includes/underscore/underscore',
            backbone: 'includes/backbone/backbone',
            common: 'js/common',
            ckeditor: 'includes/ckeditor/ckeditor',
            dropzone: 'includes/dropzone/dropzone',
            jqueryui: 'includes/jquery-ui/jquery-ui',
            utils: 'js/utils/utils',
            liquid: 'includes/jquery/imgLiquid'
        },
        
        shim: {
            underscore: {
                deps: ['jquery'],
                exports: '_'
            },
            
            backbone: {
                deps: ['underscore'],
                exports: 'Backbone'
            },
            
            bootstrap: {
                deps: ['jquery']
            },
            
            ckeditor: {
                exports: 'CKEDITOR'
            },
            
            jqueryui: {
                deps: ['jquery']
            },
            
            dropzone: {
                deps: ['jquery'],
                exports: 'Dropzone'
            },
            
            liquid: {
                deps: ['jquery']
            }
        }
    });

    require(['jquery',
             'js/userspace/profile/avatarForm',
             'js/userspace/profile/profileForm',
             'common'],

    function ($, AvatarForm) {
        "use strict";
               
        var aForm = new AvatarForm();
        
        $('.avatar-toggle-btn').on('click', function (e) {
            e.preventDefault();
            aForm.open();
        });
        
        $(document).trigger('load');
        
    });
    </script>

{% endblock %}

{% block content %}

{% for error in errors %}
    {{ error }}
{% endfor %}
{% if user.is_authenticated %}

<div class="row">
    <div class="col-sm-3">
        <img src="{{ profile.avatar.url }}" alt="Avatar" class="user-thumb" />
        <noscript><form id="upload-avatar-form" role="form" enctype="multipart/form-data" method="post" action="{% url 'user:upload_avatar' %}">
            {% csrf_token %}
            {{ avatar_form }}
        </form></noscript>
        <p><button class="btn btn-primary avatar-toggle-btn">{% trans "Change avatar" %}</button></p>
        <p><a href="{% url 'user:chpass' %}">{% trans "Change password" %}</a></p>
        <p>Points: {{ profile.rank_pts }}</p>
        <ul>
        {% for badge in profile.badges.all %}
            <li><img src="{{ badge.thumbnail.url }}" alt="{{ badge.name }}" class="user-badge-thumb" title="{{ badge.name}} - {{ badge.description | escape }}" /></li>
        {% endfor %}
        </ul>
    </div>
    <div class="col-sm-9">
        <form id="user-profile-form" method="post" action="{% url 'user:save_settings' %}">
            {% csrf_token %}
            {{ form }}
            <div class="form-group">
                <button type="submit" class="btn btn-primary">{% trans "Save changes" %}</button>
            </div>
        </form>
    </div>
</div>

<script type="text/template" id="avatar-form-tpl">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">{% trans "Choose Avatar" %}</h4>
            </div>
            <div class="modal-body">
                <div class="imgLiquidNoFill imgLiquid" style="width:250px; height:250px;"><img id="avatar-img-placeholder" /></div>
                <form id="modal-upload-form" enctype="multipart/form-data" action="{% url 'user:upload_avatar' %}" method="post">
                    {% csrf_token %}
                    {{ avatar_form }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary submit-btn">{% trans "Send" %}</button>
            </div>
        </div>
    </div>
</script>

{% include 'gallery/media-uploader.html' %}

{% else %}
    <p class="custom-booklike">{% trans "You are not allowed to visit this page. Sorry." %}</p>
{% endif %}
{% endblock %}
