{% extends 'places_core/base.html' %}
{% load staticfiles %}{% load i18n %}

{% block extra_styles %}
<style>
#list-placeholder{position:fixed;left:50%;top:50%;width:600px;height:400px;z-index:5000;margin-left:-300px;margin-top:-200px;padding:10px;background-color:#fff;border:1px solid #000;border-radius:10px;box-shadow:7px 7px 5px 0 rgba(50,50,50,.75)}#list-placeholder .placeholder-header{border-bottom:1px solid #000}#list-placeholder .placeholder-header .placeholder-close{float:right;font-size:10px;margin-right:10px;cursor:pointer}#list-placeholder .placeholder-content{height:80%}#list-placeholder .placeholder-content .list-column{height:100%;overflow-y:scroll;overflow-x:auto;list-style-type:none}#list-placeholder .placeholder-content .list-column .close-col{position:absolute;left:0;top:0}#list-placeholder .placeholder-content .list-column .list-entry-details{position:absolute;left:0;top:38px;width:100%;height:85%;background-color:#000}
</style>
{% endblock %}

{% block require_scripts %}

    <script>
    require.config({
        baseUrl: "{% static 'places_core' %}",
        
        urlArgs: "bust=" + (new Date()).getTime(),
        
        waitSeconds: 200,
        
        paths: {
            jquery: 'includes/jquery/jquery',
            bootstrap: 'includes/bootstrap/bootstrap',
            underscore: 'includes/underscore/underscore',
            backbone: 'includes/backbone/backbone',
            ui: 'js/ui/ui',
            utils: 'js/utils/utils',
            common: 'js/common',
            vector: 'includes/vectormap/jquery-jvectormap-1.2.2.min',
            worldmap: 'includes/vectormap/jquery-jvectormap-world-mill-en'
        },
        
        shim: {
            underscore: {
                deps: ['jquery'],
                exports: '_'
            },
            
            backbone: {
                deps: ['underscore'],
                exports: 'Backbone'
            },
            
            bootstrap: {
                deps: ['jquery']
            },
            
            vector: {
                deps: ['jquery']
            },
            
            worldmap: {
                deps: ['vector']
            }
        }
    });

    require(['jquery',
             'js/locations/location-list/col-view',
             'vector',
             'worldmap',
             'common'], 

    function ($, ColView) {
        
        // openPlaceholderWindow
        // ---------------------
        // Helper function: otwiera główne okno przechowujące listy
        // ---------------------------------------------------------------------
        var openPlaceholderWindow = function () {
            $('#list-placeholder')
                .fadeIn('slow')
                .find('.placeholder-close')
                .on('click', function (e) {
                    e.preventDefault();
                    closePlaceholderWindow();
                });
        };
        
        // openPlaceholderWindow
        // ---------------------
        // Helper function: zamyka główne okno przechowujące listy
        // ---------------------------------------------------------------------
        var closePlaceholderWindow = function () {
            $('#list-placeholder').fadeOut('slow', function () {
                $(this).find('.placeholder-content').empty();
                delete window.activeSublist;
            });
        };
        
        // openList
        // --------
        // Właściwa funkcja, która otwiera pierwszy "poziom" listy albo wyświetla
        // alert jeżeli w bazie nie ma kraju o podanym kodzie.
        //
        // @param event { jQuery.event || vectorMap.event} przechwycony klik
        // @param code  { string } Dwuliterowy kod kraju (case insensitive)
        // ---------------------------------------------------------------------
        var openList = function (event, code) {
            // Jeżeli jest już aktywna lista dla jakiegoś kraju, nie otwieraj
            // nowego okna.
            if (window.activeSublist !== undefined && window.activeSublist) {
                return false;
            }
            // Sprawdzamy, czy kraj jest już w bazie. Jeżeli tak, otwieramy listę.
            $.get('/api-geo/countries/?code=' + code, function (resp) {
                if (resp.length) {
                    // Bezwzględnie koniecznie jako pierwszy argument podajemy
                    // pustą tabelę - Backbone zawsze traktuje pierwszy argument
                    // jako kolekcję, co tutaj prowadzi do błędów.
                    var locationList = new ColView([], resp[0].location, 1);
                    window.activeSublist = locationList;
                    locationList.on('destroyed', function () {
                        closePlaceholderWindow();
                    });
                    openPlaceholderWindow();
                } else {
                    // TODO: coś tu trzeba pokazać.
                    alert("There is no such place");
                }
            });
        };
        
        // Mapa
        // ----
        // Wyświetla mapę wektorową i uruchamia po kliknięciu odpowiednią listę.
        // ---------------------------------------------------------------------
        $('#vector-map').vectorMap({
            
            map: 'world_mill_en', 
            
            backgroundColor: 'transparent',
            
            onRegionClick: openList, // "Odpalamy" skrypt
            
            regionStyle: {
                initial: {
                    fill: '#8D8D8D',
                    "fill-opacity": 1,
                    stroke: 'none',
                    "stroke-width": 0,
                    "stroke-opacity": 1
                },
                hover: {
                    fill: '#0082FC',
                    "fill-opacity": 0.8
                }
            }

        });
        
        // Custom Events
        // -------------
        // Uruchamianie listy lokalizacji po kliknięciu na nazwę państwa.
        // ---------------------------------------------------------------------
        $('.country-entry').on('click', function (e) {
            e.preventDefault();
            openList(e, $(this).attr('data-code'));
        });
        
        $(document).trigger('load');
        
    });
    </script>
    
{% endblock %}

{% block header %}{% endblock %}

{% block content %}

<div id="list-placeholder" style="display:none;">
    <div class="placeholder-header"><h3>{% trans "Find your place" %}<span class="fa fa-times placeholder-close">&nbsp;</span></h3></div>
    <div class="placeholder-content"></div>
</div>

<script type="text/template" id="list-col-tpl">
    <% if (tier > 1) { %><a href="#" class="close-col"><span class="fa fa-times-circle-o">&nbsp;</span></a><% } %>
    <form class="haystack-entry-form" role="presentation">
        <input type="text" class="search-entry form-control" />
    </form>
</script>

<script type="text/template" id="location-entry-tpl">
    <span class="col-description expand-entry" data-target="<%= id %>"><%= name %></span>
    <div class="list-entry-details" style="display:none;">
        <% if (followed) { %>
            <a href="#" title="{% trans "Stop following" %}" class="custom-tooltip"><span class="unfollow-entry fa fa-eye-slash" data-target="<%= id %>">&nbsp;</span></a>
        <% } else { %>
            <a href="#" title="{% trans "Follow" %}" class="custom-tooltip"><span class="follow-entry fa fa-eye" data-target="<%= id %>">&nbsp;</span></a>
        <% } %>
        <a href="/<%= slug %>" class="custom-tooltip"><span class="fa fa-play">&nbsp;</span></a>
        <a href="#" class="hide-details"><span class="fa fa-times-circle-o">&nbsp;</span></a>
    </div>
</script>


<div class="location-list-page">
    <h1 class="text-center">{% trans "Choose a country, which you love" %}</h1>
        <div id="vector-map"></div>

        <h2 class="text-center">{% trans "If you don't like maps, choose from list" %}</h2>
        {% if locations %}
        <div class="row location-list-stream">
            <div class="col-lg-2"></div>
            
            <div class="col-lg-8 main-content location-list-stream">
                {% comment %}
                    {% for location in locations %}

                        <div class="col-lg-4">
                            <a href="{{ location.get_absolute_url }}">
                            <span class="country-entry"> {{ location.name }} </span></a>
                        </div>
                        
                    {% endfor %}
                {% endcomment %}
                
                {% comment %} WTF ??? 1990 się skończył. {% endcomment %}
                <div class="col-lg-4 country-entry" data-code="PL">
                    <a href="/polska">
                        <span>
                        <img src="{% static 'places_core/img/flags/Poland-Flag-48.png' %}" />Polska
                        </span>
                    </a>
                </div>  
                
                <div class="col-lg-4 country-entry">
                    <a href="/united-states">
                        <span>
                        <img src="{% static 'places_core/img/flags/United-States-Flag-48.png' %}" />United States
                        </span>
                    </a>
                </div>  
                
                <div class="col-lg-4 country-entry">
                    <a href="/finland">
                        <span>
                        <img src="{% static 'places_core/img/flags/Finland-Flag-48.png' %}" />Finland
                        </span>
                    </a>
                </div>  
                
                <div class="col-lg-4 country-entry">
                    <a href="/portugal">
                        <span>
                        <img src="{% static 'places_core/img/flags/Portugal-Flag-48.png' %}" />Portugal
                        </span>
                    </a>
                </div>  
                
                <div class="col-lg-4 country-entry">
                    <a href="/germany">
                        <span>
                        <img src="{% static 'places_core/img/flags/Germany-Flag-48.png' %}" />Germany
                        </span>
                    </a>
                </div>  
                
                <div class="col-lg-4 country-entry">
                    <a href="/france">
                        <span>
                        <img src="{% static 'places_core/img/flags/France-Flag-48.png' %}" />France
                        </span>
                    </a>
                </div>  
                
                <div class="col-lg-4 country-entry">
                    <a href="/united-kingdom">
                        <span>
                        <img src="{% static 'places_core/img/flags/United-Kingdom-flag-48.png' %}" />United Kingdom
                        </span>
                    </a>
                </div>  
                 
                <div class="col-lg-4 country-entry">
                    <a href="/">
                        <span>
                        <img src="{% static 'places_core/img/flags/-Flag-48.png' %}" />
                        </span>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

</div>

{% endblock %}