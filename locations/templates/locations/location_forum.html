{% extends 'locations/index.html' %}
{% load staticfiles %}

{% block content %}
<div class="col-sm-9">
    <div class="discussion-list custom-tablelike">
        {% if discussions %}
            <div class="row topic-list-heading custom-list-heading">
                <div class="col-xs-1">Answers</div>
                <div class="col-xs-3">Question</div>
                <div class="col-xs-3">Category</div>
                <div class="col-xs-2">Created by</div>
                <div class="col-xs-2">Date created</div>
                <div class="col-xs-1">Status</div>
            </div>
            {% for topic in discussions %}
                <div class="row topic-list-entry custom-list-entry">
                    {% if user == topic.creator or user.is_superuser %}
                        <div class="btn-group list-entry-controls">
                            <a href="{% url 'discussion:update' topic.slug %}">
                                <button type="button" class="btn btn-default btn-sm" title="Edit"><span class="fa fa-edit"> </span></button>
                            </a>
                            <button data-target="{{ topic.slug }}" type="button" class="btn btn-danger btn-sm delete-btn" title="Delete"><span class="fa fa-times-circle-o"> </span></button>
                        </div>
                    {% endif %}
                    <div class="col-xs-1"><span class="badge">{{ topic.entry_set.count }}</span></div>
                    <div class="col-xs-3"><a href="{{ topic.slug }}">{{ topic }}</a></div>
                    <div class="col-xs-3"><a href="#">{{ topic.category }}</a></div>
                    <div class="col-xs-2">
                        <img src="{{ topic.creator.profile.avatar.url }}" alt="{{ topic.creator }}" class="user-avatar-minithumb" />
                        <a href="{% url 'user:profile' topic.creator %}">{{ topic.creator.get_full_name }}</a>
                    </div>
                    <div class="col-xs-2 topic-date-col">{{ topic.date_created | timesince }}</div>
                    <div class="col-xs-1">
                        {% if topic.status %}
                            <label class="label label-success">Active</label>
                        {% else %}
                            <label class="label label-danger">Closed</label>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        <div class="pagination">
            <span class="step-links">
                {% if discussions.has_previous %}
                    <a href="?page={{ discussions.previous_page_number }}">previous</a>
                {% endif %}
        
                <span class="current">
                    Page {{ discussions.number }} of {{ discussions.paginator.num_pages }}.
                </span>
        
                {% if discussions.has_next %}
                    <a href="?page={{ discussions.next_page_number }}">next</a>
                {% endif %}
            </span>
        </div>
        {% else %}
            <p>There are no discussions opened yet.</p>
        {% endif %}
    </div>
{% if user.is_superuser %}
{% comment %}
    Create new category - allow superusers to create dynamically forum
    categories via handy ajaxy form. This page element is hidden for
    all other users and anonymous users.
{% endcomment %}
    <button class="btn btn-primary btn-category-create"><span class="fa fa-plus-circle"> </span> New category</button>
    <div id="new-category-form" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Create forum category</h4>
                </div>
                <div class="modal-body">
                    <form role="presentation" method="post" action="" >
                        <div class="form-group">
                            <label for="category-name" class="control-label">Name</label>
                            <input type="text" id="category-name" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="category-description">Description</label>
                            <textarea id="category-description" cols="10" rows="10" class="form-control"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary submit-btn">Save</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endif %}
</div>
<script>
(function ($) {
    "use strict";
    //
    // Delete existing discussion - only owners and superadmins
    // -------------------------------------------------------------------------
    $('.delete-btn').on('click', function () {
        var question = 'Are you sure you want to delete this entry?',
            target = $(this).attr('data-target'),
            url = '/discussion/' + target + '/delete/',
            $entry = $(this).parents('.topic-list-entry:first');
        bootbox.confirm(question, function (resp) {
            if (resp) {
                sendAjaxRequest('POST', url, {
                    data: {confirm: true},
                    success: function (resp) {
                        display_alert(resp.message, resp.level);
                        if (resp.success) {
                            $entry.fadeOut('slow', function () {
                                $entry.empty().remove();
                            });
                        }
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            } 
        });
    });
    {% if user.is_superuser %}
    //
    // Create new forum category - only superadmins!
    // -------------------------------------------------------------------------
    $(document).ready(function () {
        var $modal = $('#new-category-form'),
            $form = $modal.find('form:first'),
            $sBtn = $modal.find('.submit-btn:first');
        $modal.modal({show:false});
        function submitCategoryForm(evt) {
            evt.preventDefault();
            $modal.modal('hide');
            sendAjaxRequest('POST', '/rest/discussion/', {
                data: {
                    name: $('#category-name').val(),
                    description: $('#category-description').val()
                },
                success: function (resp) {
                    display_alert('New category created', 'success');
                },
                error: function (err) {
                    console.log(err);
                }
            });
        }
        $sBtn.on('click', function (evt) {
            submitCategoryForm(evt)
        });
        $form.on('submit', function (evt) {
            submitCategoryForm(evt)
        });
        $('.btn-category-create').on('click', function (evt) {
            $modal.modal('show');
        });
    });
    {% endif %}
})(jQuery);
</script>
{% endblock %}