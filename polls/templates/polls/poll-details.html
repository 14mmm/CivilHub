{% extends 'locations/index.html' %}
{% load staticfiles %}
{% load bookmarks_tags %} {% load i18n %}
{% block title %} {{ poll.title }}, {{ location.name }} | CivilHub {% endblock %}
{% block require_scripts %}

    <script>
    require.config({
        baseUrl: "{% static 'places_core' %}",
        
        urlArgs: "bust=" + (new Date()).getTime(),
        
        waitSeconds: 200,
        
        paths: {
            jquery: 'includes/jquery/jquery',
            bootstrap: 'includes/bootstrap/bootstrap',
            underscore: 'includes/underscore/underscore',
            backbone: 'includes/backbone/backbone',
            tagsinput: 'includes/jquery/jquery.tagsinput',
            ui: 'js/ui/ui',
            utils: 'js/utils/utils',
            common: 'js/common',
            async: 'includes/require/async',
            moment: 'includes/momentjs/moment',
            mapinput: 'js/ui/jquery.mapinput'
        },
        
        shim: {
            underscore: {
                deps: ['jquery'],
                exports: '_'
            },
            
            backbone: {
                deps: ['underscore'],
                exports: 'Backbone'
            },
            
            bootstrap: {
                deps: ['jquery']
            },
            
            tagsinput: {
                deps: ['jquery']
            }
        }
    });

    require(['jquery',
             'common',
             'js/maps/minimap',
             'js/maps/pointer',
             'js/comments/commentlist',
			 'js/locations/follow'], function ($, ui) {
        
        "use strict";
        
        var runMinimap = function () {
            
            {% if map_markers %}
                var minimapData = [];
                {% for m in map_markers %}
                minimapData.push({
                    lat: '{{ m.latitude }}',
                    lng: '{{ m.longitude }}',
                    pk: '{{ m.pk }}'
                });
                {% endfor %}
                $('#minimap').minimap(minimapData);
                
            {% else %}
                return true;
            {% endif %}
        
        };
        
        setTimeout(function () {
            runMinimap();
        }, 2000);
        
        $(document).trigger('load');
        
    });
    </script>

{% endblock %}

{% block content %}

    {% include 'maps/pointer-modal-form.html' %}

    <div class="col-sm-8 main-content">
        <h1>{{ poll.title }}&nbsp;<span class="submenu-toggle"> </span></h1>
        <div class="entry-submenu">
            <ul>
                <li>{% bookmark_form for poll %}</li>
                <li><a href="#" class="map-marker-toggle">{% trans "Add map marker" %}</a></li>
            </ul>
        </div>
        <hr />
        
        {% if map_markers %}{% include 'maps/minimap.html' %}{% endif %}
        
        <div>{{ poll.question | safe }}</div>
        
        {% if can_vote %}
        <form role="form" method="post" action="{% url 'polls:verify' poll.pk %}" class="poll-form">
            {% csrf_token %}
            {{ form }}
            <div class="form-group">
                <button type="submit" class="btn btn-primary submit-btn">{% trans "Send" %}</button>
            </div>
        </form>
        {% else %}
        <p class="alert alert-info">
            {% blocktrans %}You have already voted for this poll. You can't vote again.{% endblocktrans %}
            <a href="{% url 'polls:results' poll.pk %}">{% trans "See results" %}</a>.
        </p>
        {% endif %}
    </div>
    
    <div class="col-sm-4">
        {% include 'locations/sidebar.html' %}
    </div>

{% endblock %}