{% extends 'locations/index.html' %}
{% load staticfiles %}
{% load bookmarks_tags %}{% load i18n %}

{% block title %} {{ news.title }}, {{ location.name }} | CivilHub {% endblock %}

{% block require_scripts %}

    <script>
    require.config({
        baseUrl: "{% static 'places_core' %}",
        
        urlArgs: "bust=" + (new Date()).getTime(),
        
        waitSeconds: 200,
        
        paths: {
            jquery: 'includes/jquery/jquery',
            bootstrap: 'includes/bootstrap/bootstrap',
            underscore: 'includes/underscore/underscore',
            backbone: 'includes/backbone/backbone',
            tagsinput: 'includes/jquery/jquery.tagsinput',
            ui: 'js/ui/ui',
            utils: 'js/utils/utils',
            common: 'js/common',
            async: 'includes/require/async',
            moment: 'includes/momentjs/moment',
            mapinput: 'js/ui/jquery.mapinput'
        },
        
        shim: {
            underscore: {
                deps: ['jquery'],
                exports: '_'
            },
            
            backbone: {
                deps: ['underscore'],
                exports: 'Backbone'
            },
            
            bootstrap: {
                deps: ['jquery']
            },
            
            tagsinput: {
                deps: ['jquery']
            }
        }
    });

    require(['jquery',
			 'ui',
             'common',
			 'js/locations/follow',
             'js/maps/minimap',
             'js/maps/pointer',
             'js/comments/commentlist',
			 'js/'], function ($, ui) {
        
        "use strict";
        
        var runMinimap = function () {
            
            {% if map_markers %}
                var minimapData = [];
                {% for m in map_markers %}
                minimapData.push({
                    lat: '{{ m.latitude }}',
                    lng: '{{ m.longitude }}',
                    pk: '{{ m.pk }}'
                });
                {% endfor %}
                $('#minimap').minimap(minimapData);
                
            {% else %}
                return true;
            {% endif %}
        
        };
        
        setTimeout(function () {
            runMinimap();
        }, 2000);
        
        $(document).trigger('load');
        
    });
    </script>

{% endblock %}

{% block content %}

    {% include 'maps/pointer-modal-form.html' %}

<div class="col-sm-8 main-content">
	<div class="blog-detail">
<div class="row">
	
		<div class="col-md-2">
			<div class="entry-avatar-col">
				<img src="{{ news.creator.profile.avatar.url }}" alt="{{ news.creator.get_full_name }}" class="user-avatar user-window-toggle" data-target="{{ news.creator.pk }}" />
				{{ news.creator.profile.rank_pts }}
			
            {% include 'locations/share_buttons.html' %}
            
            </div>
		</div>
		
		<!-- News -->
		<div class="col-md-10">
			<!-- News header -->
			<div class="row news-header">
				<!-- News title -->
				<div class="col-md-11">
					<h1>{{ title }}</h1>
					<div class="news-meta">
						<p>{% trans "Created by" %} <a href="{{ news.creator.profile.get_absolute_url }}"><span class="user-window-toggle" data-target="{{ news.creator.pk }}">{{ news.creator.get_full_name }}</span></a> {{ news.date_created }}</p>
					</div>
				</div>
				
				<!-- News settings -->
				<div class="col-md-1">
				{% if user.is_authenticated %}
				<h1><span class="submenu-toggle"></h1>
				{% endif %}

					<div class="entry-submenu">
						<ul>
							<li>{% bookmark_form for news %}</li>
							{% if user.is_authenticated and user != news.creator %}
							<li><a class="report-abuse-link" href="{% url 'reports:report' app_label='blog' model_label='news' object_pk=news.pk %}">
								{% trans "Report abuse" %}</a></li>
							{% endif %}
							{% if user.is_authenticated and user == news.creator or is_moderator %}
							<li><a href="{% url 'blog:update' news.slug %}">{% trans "Edit" %}</a></li>
							<li><a href="">{% trans "Delete" %}</a></li>
							<li><a href="#" class="map-marker-toggle">{% trans "Add map marker" %}</a></li>
							{% endif %}
						</ul>
					</div>
				</div>
			</div>
			
			<!-- News content -->
			<div class="row">
				<article>
					<div  class="news-contetn">{{ news.content | safe }}</div>
				</article>
				
				<div class="comments-{{ news.pk }}"></div>
				
				<div class="sprite-icon">
					<span class="ch-icon ch-tags"> </span>{% trans "Tags" %}:
					{% for tag in news.tags.all %}
						<a href="{% url 'locations:tag_search' slug=news.location.slug tag=tag %}">{{ tag }}</a>,&nbsp;
					{% endfor %}
				</div>
				<br />
				{% if news.category %}
				<div class="sprite-icon">
					<span class="ch-icon ch-category"></span>{% trans "Category" %}: <a href="{% url 'locations:category_search' slug=news.location.slug app='blog' model='news' category=news.category.pk %}">{{ news.category }}</a>
				</div>
				{% endif %}

				
			</div>
			
			<!-- News comments -->
            <div class="row">
                <input type="hidden" id="target-id" value="{{ news.pk }}" />
                <input type="hidden" id="target-label" value="blog" />
                <input type="hidden" id="target-type" value="{{ content_type }}" />
                <input type="hidden" id="target-user" value="{{ user.username }}" />
                <input type="hidden" id="target-user-fullname" value="{{ user.get_full_name }}" />
                <input type="hidden" id="target-avatar" value="{{ user.profile.avatar.url }}" />
                <div class="sprite-icon"> 
                <span class="ch-icon ch-comments"></span>{{ news.get_comment_count }} {% trans "Comments" %}: 
                    <a class="comment-toggle" data-target="{{ news.pk }}" href="#">{% trans "Hide comments" %}</a>
                </div>
                {% include 'comments/commentlist.html' %}
            </div>
		</div>

        </div>
	</div>
</div>
    <div class="col-sm-4">
        {% include 'locations/sidebar.html' %}
    </div>

{% endblock %}