{% extends 'places_core/base.html' %}
{% load staticfiles %}{% load i18n %}

{% comment %}Główny widok mapy.{% endcomment %}

{% block content %}
<nav class="navbar navbar-default navbar-inverse" role="navigation">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#map-navbar-collapse">
        <span class="sr-only">{% trans "Toggle navigation" %}</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">{% trans "Start" %}</a>
    </div>
    <div class="collapse navbar-collapse" id="map-navbar-collapse">
        <form class="navbar-form navbar-nav">
            Places <input type="checkbox" data-target="location" class="map-filter-toggle" checked="checked" />
            Ideas <input type="checkbox" data-target="idea" class="map-filter-toggle" checked="checked" />
            Polls <input type="checkbox" data-target="poll" class="map-filter-toggle" checked="checked" />
            Discussions <input type="checkbox" data-target="discussion" class="map-filter-toggle" checked="checked" />
            News <input type="checkbox" data-target="news" class="map-filter-toggle" checked="checked" />
        </form>
        <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text" class="form-control" placeholder="{% trans "Search" %}">
            </div>
            <a class="btn btn-default">{% trans "Search" %}</a>
        </form>
    </div>
</nav>
<div id="map"></div>
{% endblock %}

{% block footer_scripts %}
<script>
(function ($) {
    "use strict";
    // Globals
    var MEDIA_URL = '{% static 'maps/icons' %}';
    // Shortcut to get list of active filters
    var getFilters = function () {
        var filterToggles = $('.map-filter-toggle'),
            filters = [];
            
        filterToggles.each(function () {
            if ($(this).is(':checked')) {
                filters.push($(this).attr('data-target'));
            }
        });
        
        return filters;
    }
    //
    // Prepare Google Map
    // -------------------------------------------------------------------------
    //
    function civilGoogleMap(markers, options) {

        var defaults = {
                center: new google.maps.LatLng(0, 0),
                zoom: 2
            },
            mapOptions = $.extend(defaults, options);
        
        map = {
            map: new google.maps.Map(document.getElementById("map"), mapOptions),
            markerList: markers,
            markers: [],
            
            placeMarker: function (location, data) {
                var _this = this,
                    marker = new google.maps.Marker({
                        position: location,
                        map: _this.map
                    });
                if (data) {
                    $.extend(marker, data);
                }
                _this.markers.push(marker);
                
                return marker;
            },
            
            infoWindow: function (content) {
                var win = new google.maps.InfoWindow({
                    content: content
                });
                return win;
            },
            
            filter: function (filters) {
                var _this = this;
                
                $(_this.markers).each(function (idx, marker) {
                    if (filters.indexOf(marker.type) >= 0) {
                        marker.setVisible(true);
                    } else {
                        marker.setVisible(false);
                    }
                });
            },
            
            render: function () {
                var _this = this;
                
                $(_this.markerList).each(function () {
                    var marker = this,
                        position = new google.maps.LatLng(
                            marker.latitude,
                            marker.longitude
                        ),
                        m = _this.placeMarker(position, marker);
                    
                    if (!_.isUndefined(marker.content_type)) {
                        m.setIcon(MEDIA_URL + '/marker-' + marker.type + '.png');
                    }
                        
                    google.maps.event.addListener(m, 'click', function(event) {
                        var w = _this.infoWindow('<a href="' + marker.url + '">Go to</a>');
                        w.open(_this.map, m);
                    });
                })
            }
        }
        
        return map;
    }
    //
    // Fetch objects from server and create map
    // -------------------------------------------------------------------------
    //
    $.get('/maps/pointers/', function (resp) {
        var markers = [], map = null;
        resp = JSON.parse(resp);
        if (resp.success) {
            $(resp.locations).each(function () {
                markers.push(this);
            });
            $(resp.pointers).each(function () {
                markers.push(this);
            });
            map = civilGoogleMap(markers);
            map.render();
            map.filter(getFilters());
            $('.map-filter-toggle').bind('change', function (evt) {
                evt.preventDefault;
                map.filter(getFilters());
            });
        } else {
            console.log("Failed to load map data");
        }
    });
})(jQuery);
</script>
{% endblock %}