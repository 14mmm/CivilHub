{% extends 'places_core/base.html' %}
{% load staticfiles %}{% load i18n %}

{% comment %}Główny widok mapy.{% endcomment %}

{% block content %}
<nav class="navbar navbar-default navbar-inverse" role="navigation">
    <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#map-navbar-collapse">
        <span class="sr-only">{% trans "Toggle navigation" %}</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">{% trans "Start" %}</a>
    </div>
    <div class="collapse navbar-collapse" id="map-navbar-collapse">
        <form class="navbar-form navbar-nav">
            Places <input type="checkbox" data-target="location" class="map-filter-toggle" checked="checked" />
            Ideas <input type="checkbox" data-target="idea" class="map-filter-toggle" checked="checked" />
            Polls <input type="checkbox" data-target="poll" class="map-filter-toggle" checked="checked" />
            Discussions <input type="checkbox" data-target="discussion" class="map-filter-toggle" checked="checked" />
            News <input type="checkbox" data-target="news" class="map-filter-toggle" checked="checked" />
        </form>
        <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text" class="form-control" placeholder="{% trans "Search" %}">
            </div>
            <a class="btn btn-default">{% trans "Search" %}</a>
        </form>
    </div>
</nav>
<div id="map"></div>
{% endblock %}

{% block footer_scripts %}

<!-- TEST -->
<script src="{% static 'places_core/includes/google/markerclusterer.js' %}"></script>
<script src="{% static 'maps/js/styles.js' %}"></script>

<script>
(function ($) {
    "use strict";
    // Globals
    var MEDIA_URL = '{% static 'maps' %}';
    var STYLES = [[{
        url: MEDIA_URL + '/images/people35.png',
        height: 35,
        width: 35,
        anchor: [16, 0],
        textColor: '#ff00ff',
        textSize: 10
    }, {
        url: MEDIA_URL + '/images/people45.png',
        height: 45,
        width: 45,
        anchor: [24, 0],
        textColor: '#ff0000',
        textSize: 11
    }, {
        url: MEDIA_URL + '/images/people55.png',
        height: 55,
        width: 55,
        anchor: [32, 0],
        textColor: '#ffffff',
        textSize: 12
    }], [{
        url: MEDIA_URL + '/images/conv30.png',
        height: 27,
        width: 30,
        anchor: [3, 0],
        textColor: '#ff00ff',
        textSize: 10
    }, {
        url: MEDIA_URL + '/images/conv40.png',
        height: 36,
        width: 40,
        anchor: [6, 0],
        textColor: '#ff0000',
        textSize: 11
    }, {
        url: MEDIA_URL + '/images/conv50.png',
        width: 50,
        height: 45,
        anchor: [8, 0],
        textSize: 12
    }], [{
        url: MEDIA_URL + '/images/heart30.png',
        height: 26,
        width: 30,
        anchor: [4, 0],
        textColor: '#ff00ff',
        textSize: 10
    }, {
        url: MEDIA_URL + '/images/heart40.png',
        height: 35,
        width: 40,
        anchor: [8, 0],
        textColor: '#ff0000',
        textSize: 11
    }, {
        url: MEDIA_URL + '/images/heart50.png',
        width: 50,
        height: 44,
        anchor: [12, 0],
        textSize: 12
    }]];
    // Shortcut to get list of active filters
    var getFilters = function () {
        var filterToggles = $('.map-filter-toggle'),
            filters = [];
            
        filterToggles.each(function () {
            if ($(this).is(':checked')) {
                filters.push($(this).attr('data-target'));
            }
        });
        
        return filters;
    }
    //
    // Prepare Google Map
    // -------------------------------------------------------------------------
    //
    function civilGoogleMap(mapData) {
        
        var imageUrl = 'http://chart.apis.google.com/chart?cht=mm&chs=24x32&' +
            'chco=FFFFFF,008CFF,000000&ext=.png';
        
        var map = {
            map: null,
            markerClusterer: null,
                
            refreshMap: function (filters) {
                var _this = this,
                    markers = [],
                    i, latLng, marker,
                    markerImage = new google.maps.MarkerImage(imageUrl,
                        new google.maps.Size(24, 32));
                        
                if (_this.markerClusterer) {
                    _this.markerClusterer.clearMarkers();
                }
                
                for (i = 0; i < mapData.length; ++i) {
                    latLng = new google.maps.LatLng(mapData[i].latitude,
                        mapData[i].longitude)
                    marker = new google.maps.Marker({
                        position: latLng,
                        draggable: true,
                        icon: MEDIA_URL + '/icons/marker-' + mapData[i].type + '.png'
                    });
                    $.extend(marker, mapData[i]);
                    if (filters && filters.indexOf(marker.type) >= 0 || !filters) {
                        markers.push(marker);
                    }
                }
                
                _this.markerClusterer = new MarkerClusterer(_this.map, markers, {
                    maxZoom: 10,
                    gridSize: 30,
                    styles: STYLES[1]
                });
            },
            
            initialize: function () {
                var _this = this,
                    refresh = document.getElementById('refresh'),
                    clear = document.getElementById('clear');
                    
                _this.map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 5,
                    center: new google.maps.LatLng(52.0, 23.0)
                });
                
                _this.refreshMap();
            },
            
            clearClusters: function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.markerClusterer.clearMarkers();
            }
        };
        
        map.initialize();
        
        return map;
    }
    //
    // Fetch objects from server and create map
    // -------------------------------------------------------------------------
    //
    $.get('/maps/pointers/', function (resp) {
        var markers = [], map = null;
        resp = JSON.parse(resp);
        if (resp.success) {
            $(resp.locations).each(function () {
                markers.push(this);
            });
            $(resp.pointers).each(function () {
                markers.push(this);
            });
            map = civilGoogleMap(markers);
            $('.map-filter-toggle').bind('change', function (evt) {
                evt.preventDefault;
                map.refreshMap(getFilters());
            });
        } else {
            console.log("Failed to load map data");
        }
    });
})(jQuery);
</script>

{% endblock %}